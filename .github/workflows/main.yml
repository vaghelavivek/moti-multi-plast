on: 
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual execution

jobs:
  fetch-hosts:
    name: Fetch and Prepare Hosts
    runs-on: ubuntu-latest
    outputs:
      hosts: ${{ steps.set-hosts.outputs.hosts }}  # Store hosts as output for next job
    steps:
      - name: Fetch host list from API
        id: fetch-hosts
        run: |
          RESPONSE=$(curl -s "https://api.coursesprout.com/api/debug-comment/sob")
          echo "Raw API Response: $RESPONSE"  # Debug: Print API response
          echo "$RESPONSE" > api_response.json  # Save response for validation

      - name: Validate JSON Structure
        run: |
          cat api_response.json | jq .  # Check if the response is valid JSON

      - name: Set Hosts Output
        id: set-hosts
        run: |
          HOSTS=$(cat api_response.json | jq -c '.hosts' || echo "[]")  # Avoid errors if hosts key is missing
          echo "hosts=$HOSTS" >> $GITHUB_OUTPUT

  log-hosts:
    name: Log Hosts
    needs: fetch-hosts
    runs-on: ubuntu-latest
    strategy:
      matrix:
        host: ${{ fromJson(needs.fetch-hosts.outputs.hosts).*.ip }}
    steps:
      - name: Log host details
        run: |
          echo "Processing Host: ${{ matrix.host }}"
